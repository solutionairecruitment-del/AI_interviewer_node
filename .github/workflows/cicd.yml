name: Build and Deploy to Google Cloud Platform Cloud

on:
  push:
    branches:
      - release-1.0

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Confirm auth and project
        run: |
          gcloud auth list
          gcloud config set project "${{ secrets.GCP_PROJECT_ID }}"

      - name: Ensure Artifact Registry repo exists (idempotent)
        run: |
          set -e
          REPO="demo-deployment-repo"
          LOCATION="asia-south1"
          if ! gcloud artifacts repositories describe "$REPO" --location="$LOCATION" >/dev/null 2>&1; then
            gcloud artifacts repositories create "$REPO" \
              --repository-format=docker \
              --location="$LOCATION" \
              --description="Docker repo for ai-interviewer"
          fi

      - name: Configure Docker for Google Artifact Registry
        run: |
          gcloud auth configure-docker asia-south1-docker.pkg.dev

      - name: Build and push Docker image to Artifact Registry
        run: |
          IMAGE="asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/demo-deployment-repo/ai-interviewer"
          docker build -t "$IMAGE:$GITHUB_SHA" -t "$IMAGE:latest" .
          docker push "$IMAGE:$GITHUB_SHA"
          docker push "$IMAGE:latest"

      - name: Deploy to Cloud Run (public)
        run: |
          IMAGE="asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/demo-deployment-repo/ai-interviewer:$GITHUB_SHA"
          gcloud run deploy nodejs-interview-backend \
            --image "$IMAGE" \
            --platform managed \
            --region asia-south1 \
            --allow-unauthenticated \
            --port 3000 \
            --quiet

      - name: Output service URL
        run: |
          gcloud run services describe ai-interviewer --region asia-south1 --format='value(status.url)'
